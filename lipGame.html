<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>lipGame</title>
</head>
<body>
    <canvas id="mainCanvas" width = 300 height = 300 onmousemove="mouseMove(event)" onmouseup="mouseClick(event)" style="height:600px; width: 600px; image-rendering: pixelated;"></canvas>
    <div>
        <p>Health:</P>
        <p id="health">100</p>
        <p>Block Information:</p>
        <p id="info"></p>
    </div>
    <script>
        var canvas = document.getElementById("mainCanvas");
        var canvasWidth = canvas.width;
        var canvasHeight = canvas.height;
        var ctx = canvas.getContext("2d");
        var canvasData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
        var rect = canvas.getBoundingClientRect();
        ctx.imageSmoothingEnabled = false;
        ctx.webkitImageSmoothingEnabled =false;
        var mouseX = 0;
        var mouseY = 0;
        var mouseA = -1;
        var elementSize = parseInt(canvas.style.height.substr(0,3));
        //var gamefolder = "/projects/"
        var gamefolder = "http://www.gerben-meijer.nl/projects/";

        //Images
        var images = {
            "backgrounds": [
                    new Image(),
                    new Image(),
                    new Image()
            ],
            "fog": new Image(),
            "marker": new Image(),
            "trap": new Image()
        }
        images.backgrounds[0].src = gamefolder + "back_0.png";
        images.backgrounds[1].src = gamefolder + "back_1.png";
        images.backgrounds[2].src = gamefolder + "back_2.png";
        images.fog.src = gamefolder + "back_fog.png";
        images.marker.src = gamefolder + "marker.png";
        images.trap.src = gamefolder + "trap.png";

        //Make a player object
        var player = {"x": 0, "y":0, "visitedCoords": [[0 ,0]]};
        //Make an empty grid
        var map = [];
        var gridWidth = 60;
        var gridHeight = 60;
        for (var i = 0; i < gridWidth; i++){
            var temp = [];
            for (var j = 0; j <gridHeight; j++) {
                temp.push({});
            }
            map.push(temp);
        }

        console.log(map);

        //SpecialList
        var specialList = [
            {"id": 0, "name": "Nothing Special", "signal": "", "chance": 10},
            {"id": 1, "name": "Trap", "signal": "It's a trap!", "chance": 3},
            {"id": 2, "name": "Treasure Room", "signal": "GOLDDDDDD", "chance": 0.1}
        ]
        var totalSpecialChance = 0;
        for(var special in specialList){
            totalSpecialChance += specialList[special].chance;
        }

        function mouseMove(e){
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            newMouseA = -1;
            if (mouseX > elementSize*2/3 && mouseY > elementSize*1/3 & mouseY < elementSize*2/3){ newMouseA = 0;}
            if (mouseY < elementSize*1/3 && mouseX > elementSize*1/3 & mouseX < elementSize*2/3){ newMouseA = 1;}
            if (mouseX < elementSize*1/3 && mouseY > elementSize*1/3 & mouseY < elementSize*2/3){ newMouseA = 2;}
            if (mouseY > elementSize*2/3 && mouseX > elementSize*1/3 & mouseX < elementSize*2/3){ newMouseA = 3;}
            if (newMouseA != mouseA){
                mouseA = newMouseA;
                draw();
            }
        }

        function mouseClick(e){
            mouseMove(e);
            move(mouseA);

        }

        function hasVisited(x, y){
            for (coord in player.visitedCoords){
                if ( player.visitedCoords[coord][0] == x && player.visitedCoords[coord][1] == y ){
                    return true
                }
            }
            return false;
        }

        function rotateAndPaintImage ( context, image, angleInRad , positionX, positionY, axisX, axisY ) {
            context.translate( positionX, positionY );
            context.rotate( angleInRad );
            context.drawImage( image, -axisX, -axisY );
            context.rotate( -angleInRad );
            context.translate( -positionX, -positionY );
        }

        function exists(x, y){
            return (x >= 0 && x < gridWidth && y >= 0 && y < gridHeight);
        }
        function drawPixel (x, y, r, g, b, a) {
            var index = (x + y * canvasWidth) * 4;

            canvasData.data[index + 0] = r;
            canvasData.data[index + 1] = g;
            canvasData.data[index + 2] = b;
            canvasData.data[index + 3] = a;
        }

        function updateCanvas() {
            ctx.putImageData(canvasData, 0, 0);
        }

        function getInformation(x, y){
            if (x > 0 && x < gridWidth && y > 0 && y < gridHeight){
                return map[x][y];
            } else {
               return {"x": -1, "y":-1, "background": 0, "special": 0}
            }
        }

        function getSpecialString(x, y){
            var list = [];
            var outString = "";
            list.push(getInformation(x-1, y).special);
            list.push(getInformation(x+1, y).special);
            list.push(getInformation(x, y-1).special);
            list.push(getInformation(x, y+1).special);
            console.log(list);
            for (special in specialList){
                if(list.lastIndexOf(special) != -1){
                    outString += specialList[special].signal + "\n";
                }
            }
            return outString;
        }

        function generateMap(){
            for ( var x = 0; x < gridWidth; x++){
                for(var y = 0; y < gridHeight; y++){
                    var temp = {"x": x, "y": y, "background": 0, "special": 0};
                    var detBackgr = parseInt(Math.random() * 3);
                    var detSpecial = generateSpecial();
                    console.log(detSpecial);
                    //Check if our special is not already on another block next to us
                    if ((detSpecial == 0) || !(getInformation(x-1, y).special == detSpecial || getInformation(x ,y-1).special == detSpecial)){
                        temp.special = detSpecial;
                    }

                    //background determination
                    switch(parseInt(Math.random()*3)){
                        case 0:
                            temp.background = detBackgr;
                            break;
                        case 1:
                            temp.background = getInformation(x-1, y).background;
                            break;
                        case 2:
                            temp.background = getInformation(x, y-1).background;
                            break;
                        default:
                            console.log("Yeah, problems");
                    }
                    map[x][y] = temp;

                }
            }
        }


        function move(a){
            // a = 0 right, a = 1 top, a = 2 left, a = 3 down.
            var dx = 0;
            var dy = 0;
            switch (a){
                case 0:
                    dx = 1;
                    break;
                case 1:
                    dy = -1;
                    break;
                case 2:
                    dx = -1;
                    break;
                case 3:
                    dy = 1;
                    break;
                default:
                    break;
                }
            if (a != -1 && exists(player.x + dx, player.y + dy)){
                player.x += dx;
                player.y += dy;
                player.visitedCoords.push([player.x, player.y])
                document.getElementById("info").innerHTML = getSpecialString(player.x, player.y);
                draw();
            }
        }

        function generateSpecial(){
            var choice = Math.random()*totalSpecialChance;
            for (var special in specialList){
                choice -= specialList[special].chance;
                if (choice < 0){
                    return specialList[special].id;
                }
            }
        }
        function drawDot(x, y, w, h, r, g, b){
            for (var dx = 0; dx < w; dx++){
                for (var dy = 0; dy < h; dy++){
                    drawPixel(x + dx, y + dy, r, g, b, 255);
                }
            }
        }
        function drawMap(){
            ctx.clearRect(0,0,canvas.width,canvas.height);
            var canvasData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
            for ( var x = 0; x < gridWidth; x++) {
                for (var y = 0; y < gridHeight; y++){
                    switch(getInformation(x,y).background){
                        case 0:
                            drawDot(x*4, y*4, 4, 4, 255, 0, 0);
                            break;
                        case 1:
                            drawDot(x*4, y*4, 4, 4, 0, 255, 0);
                            break;
                        case 2:
                            drawDot(x*4, y*4, 4, 4, 0, 0, 255);
                            break;
                        default:
                            console.log(getInformation(x,y).background);
                    }

                    switch(getInformation(x,y).special){
                        case 0:
                            drawDot(x*4 + gridWidth*4 + 4, y*4, 4, 4, 0, 255, 255);
                            break;
                        case 1:
                            drawDot(x*4 + gridWidth*4 + 4, y*4, 4, 4, 255, 0, 0);
                            break;
                        case 2:
                            drawDot(x*4 + gridWidth*4 + 4, y*4, 4, 4, 255, 255, 0);
                            break;
                        default:
                            //console.log(getInformation(x,y).special);
                            break;
                    }

                }
            }
            updateCanvas();
        }

        function draw(){




            for ( var x = -1; x < 2; x++) {
                for (var y = -1; y < 2; y++) {
                    if (( x == 0 && y == 0 )|| hasVisited(player.x + x, player.y + y)){
                        ctx.drawImage(images.backgrounds[getInformation(player.x + x, player.y + y).background], 100 + x*100, 100+ y*100);
                    } else {

                        ctx.drawImage(images.fog, 100+x*100, 100+y*100)
                    }
                    if (x == 0 && y == 0 ){
                        switch(getInformation(player.x + x, player.y + y).special){
                            case 0:
                                //zweg
                                break;
                            case 1:
                                ctx.drawImage(images.trap, 100, 100);
                                break;
                        }
                    }
                }
            }
            switch (mouseA){
                case 0:
                    ctx.drawImage(images.marker, 200, 100);
                    break;
                case 1:
                    ctx.drawImage(images.marker, 100, 000);
                    break;
                case 2:
                    ctx.drawImage(images.marker, 000, 100);
                    break;
                case 3:
                    ctx.drawImage(images.marker, 100, 200);
                    break;
                default:
                    break;
            }


        }




        generateMap();
        draw();
        console.log(map);
        generateSpecial();
    </script>
</body>
</html>